#!/bin/bash
# Script de ensamblaje para S2I

echo "Instalando dependencias del sistema..."
/usr/bin/yum install -y gcc-c++ python3-devel

echo "Instalando dependencias de Python..."
/usr/bin/pip3 install --no-cache-dir -r /tmp/src/requirements.txt

echo "Compilando el módulo C++..."
cd /tmp/src
/usr/bin/pip3 install pybind11
PYBIND11_INCLUDES=$(/usr/bin/python3 -m pybind11 --includes)
/usr/bin/g++ -O3 -Wall -shared -std=c++11 -fPIC $PYBIND11_INCLUDES bindings.cpp -o cosine_module.so

echo "Copiando archivos..."
mkdir -p /opt/app-root/src
cp -r /tmp/src/main.py /tmp/src/cosine_module.so /tmp/src/requirements.txt /opt/app-root/src/

echo "Configurando caché..."
mkdir -p /opt/app-root/src/cache
chmod -R 777 /opt/app-root/src/cache

# Asegurarse de que S2I reconozca main.py como el módulo principal
echo "Configurando APP_MODULE..."
echo "export APP_MODULE=main:app" >> /opt/app-root/etc/s2i.env

echo "Limpiando..."
rm -rf /tmp/src/*